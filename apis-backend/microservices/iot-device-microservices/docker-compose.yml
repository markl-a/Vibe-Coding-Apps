version: '3.8'

services:
  # MongoDB for Device Service
  device-db:
    image: mongo:7
    container_name: iot-device-db
    environment:
      MONGO_INITDB_DATABASE: iot_devices
    ports:
      - "27021:27017"
    volumes:
      - device-data:/data/db
    networks:
      - iot-network

  # InfluxDB for Time-Series Data
  influxdb:
    image: influxdb:2.7
    container_name: iot-influxdb
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: adminpassword
      DOCKER_INFLUXDB_INIT_ORG: iot-org
      DOCKER_INFLUXDB_INIT_BUCKET: device-data
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: my-super-secret-auth-token
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    networks:
      - iot-network

  # Redis for Analytics & Caching
  redis:
    image: redis:7-alpine
    container_name: iot-redis
    command: redis-server --appendonly yes
    ports:
      - "6381:6379"
    volumes:
      - redis-data:/data
    networks:
      - iot-network

  # RabbitMQ for Alert Service
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: iot-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: iot
      RABBITMQ_DEFAULT_PASS: iotpassword
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - iot-network

  # Device Service
  device-service:
    build: ./device-service
    container_name: iot-device-service
    environment:
      PORT: 5001
      MONGODB_URI: mongodb://device-db:27017/iot_devices
    ports:
      - "5001:5001"
    depends_on:
      - device-db
    networks:
      - iot-network
    restart: unless-stopped

  # Data Service
  data-service:
    build: ./data-service
    container_name: iot-data-service
    environment:
      PORT: 5002
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: my-super-secret-auth-token
      INFLUXDB_ORG: iot-org
      INFLUXDB_BUCKET: device-data
      DEVICE_SERVICE_URL: http://device-service:5001
    ports:
      - "5002:5002"
    depends_on:
      - influxdb
      - device-service
    networks:
      - iot-network
    restart: unless-stopped

  # Analytics Service
  analytics-service:
    build: ./analytics-service
    container_name: iot-analytics-service
    environment:
      PORT: 5003
      REDIS_URL: redis://redis:6379
      DATA_SERVICE_URL: http://data-service:5002
      DEVICE_SERVICE_URL: http://device-service:5001
    ports:
      - "5003:5003"
    depends_on:
      - redis
      - data-service
    networks:
      - iot-network
    restart: unless-stopped

  # Alert Service
  alert-service:
    build: ./alert-service
    container_name: iot-alert-service
    environment:
      PORT: 5004
      RABBITMQ_URL: amqp://iot:iotpassword@rabbitmq:5672
      DATA_SERVICE_URL: http://data-service:5002
      DEVICE_SERVICE_URL: http://device-service:5001
    ports:
      - "5004:5004"
    depends_on:
      - rabbitmq
      - data-service
    networks:
      - iot-network
    restart: unless-stopped

  # API Gateway
  api-gateway:
    build: ./api-gateway
    container_name: iot-api-gateway
    environment:
      PORT: 5000
      DEVICE_SERVICE_URL: http://device-service:5001
      DATA_SERVICE_URL: http://data-service:5002
      ANALYTICS_SERVICE_URL: http://analytics-service:5003
      ALERT_SERVICE_URL: http://alert-service:5004
      API_KEY_SECRET: iot-platform-secret-key-2024
    ports:
      - "5000:5000"
    depends_on:
      - device-service
      - data-service
      - analytics-service
      - alert-service
    networks:
      - iot-network
    restart: unless-stopped

networks:
  iot-network:
    driver: bridge

volumes:
  device-data:
  influxdb-data:
  redis-data:
  rabbitmq-data:
