#!/usr/bin/env python3
"""
env_manager.py - ç’°å¢ƒè®Šé‡ç®¡ç†å·¥å…·
ç®¡ç†å’Œé©—è­‰ç’°å¢ƒè®Šé‡é…ç½®
"""

import os
import sys
import argparse
from pathlib import Path
from typing import Dict, List, Optional, Set
import re


class EnvManager:
    """ç’°å¢ƒè®Šé‡ç®¡ç†å™¨"""

    def __init__(self, env_file: str = '.env'):
        self.env_file = Path(env_file)
        self.variables = {}
        self.required_vars = set()
        self.optional_vars = set()

    def load(self) -> Dict[str, str]:
        """åŠ è¼‰ .env æ–‡ä»¶"""
        if not self.env_file.exists():
            print(f"è­¦å‘Š: {self.env_file} ä¸å­˜åœ¨")
            return {}

        with open(self.env_file, 'r', encoding='utf-8') as f:
            for line_num, line in enumerate(f, 1):
                line = line.strip()

                # è·³éç©ºè¡Œå’Œè¨»è§£
                if not line or line.startswith('#'):
                    continue

                # è§£æè®Šé‡
                match = re.match(r'^([A-Za-z_][A-Za-z0-9_]*)\s*=\s*(.*)$', line)
                if match:
                    key, value = match.groups()
                    # ç§»é™¤å¼•è™Ÿ
                    value = value.strip('"\'')
                    self.variables[key] = value
                else:
                    print(f"è­¦å‘Š: ç¬¬ {line_num} è¡Œæ ¼å¼ç„¡æ•ˆ: {line}")

        return self.variables

    def save(self, variables: Optional[Dict[str, str]] = None):
        """å„²å­˜è®Šé‡åˆ° .env æ–‡ä»¶"""
        if variables:
            self.variables = variables

        lines = []

        # æ·»åŠ æ¨™é¡Œè¨»è§£
        lines.append("# Environment Variables")
        lines.append(f"# Generated by env_manager.py")
        lines.append("")

        # å¯«å…¥è®Šé‡
        for key, value in sorted(self.variables.items()):
            # å¦‚æœå€¼åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ï¼Œæ·»åŠ å¼•è™Ÿ
            if ' ' in value or any(c in value for c in ['$', '#', '"', "'"]):
                value = f'"{value}"'
            lines.append(f"{key}={value}")

        with open(self.env_file, 'w', encoding='utf-8') as f:
            f.write('\n'.join(lines) + '\n')

        print(f"âœ“ å·²å„²å­˜åˆ° {self.env_file}")

    def set_var(self, key: str, value: str):
        """è¨­ç½®è®Šé‡"""
        if not re.match(r'^[A-Za-z_][A-Za-z0-9_]*$', key):
            raise ValueError(f"ç„¡æ•ˆçš„è®Šé‡å: {key}")

        self.variables[key] = value
        print(f"âœ“ å·²è¨­ç½® {key}")

    def get_var(self, key: str) -> Optional[str]:
        """ç²å–è®Šé‡"""
        return self.variables.get(key)

    def delete_var(self, key: str):
        """åˆªé™¤è®Šé‡"""
        if key in self.variables:
            del self.variables[key]
            print(f"âœ“ å·²åˆªé™¤ {key}")
        else:
            print(f"è­¦å‘Š: {key} ä¸å­˜åœ¨")

    def list_vars(self, show_values: bool = False):
        """åˆ—å‡ºæ‰€æœ‰è®Šé‡"""
        if not self.variables:
            print("æ²’æœ‰ç’°å¢ƒè®Šé‡")
            return

        print(f"\nç’°å¢ƒè®Šé‡ ({len(self.variables)}):")
        print("="*60)

        for key in sorted(self.variables.keys()):
            if show_values:
                value = self.variables[key]
                # éš±è—æ•æ„Ÿå€¼
                if self._is_sensitive(key):
                    value = '*' * 8
                print(f"{key} = {value}")
            else:
                print(f"- {key}")

    def validate(self, required: Optional[List[str]] = None) -> bool:
        """é©—è­‰ç’°å¢ƒè®Šé‡"""
        print("\né©—è­‰ç’°å¢ƒè®Šé‡...")

        missing = []
        invalid = []

        # æª¢æŸ¥å¿…éœ€çš„è®Šé‡
        if required:
            for var in required:
                if var not in self.variables:
                    missing.append(var)
                elif not self.variables[var]:
                    invalid.append((var, "å€¼ç‚ºç©º"))

        # æª¢æŸ¥æ•æ„Ÿè®Šé‡
        for key, value in self.variables.items():
            if self._is_sensitive(key):
                if len(value) < 8:
                    invalid.append((key, "å€¼éçŸ­ï¼Œå»ºè­°è‡³å°‘ 8 å€‹å­—ç¬¦"))

        # å ±å‘Šçµæœ
        all_valid = not missing and not invalid

        if missing:
            print(f"\nâŒ ç¼ºå°‘å¿…éœ€çš„è®Šé‡:")
            for var in missing:
                print(f"  - {var}")

        if invalid:
            print(f"\nâš ï¸  ç„¡æ•ˆçš„è®Šé‡:")
            for var, reason in invalid:
                print(f"  - {var}: {reason}")

        if all_valid:
            print("âœ“ æ‰€æœ‰ç’°å¢ƒè®Šé‡éƒ½æœ‰æ•ˆ")

        return all_valid

    def generate_template(self, output_file: str = '.env.example'):
        """ç”Ÿæˆç¯„æœ¬æ–‡ä»¶"""
        lines = [
            "# Environment Variables Template",
            "# Copy this file to .env and fill in the values",
            "",
        ]

        for key in sorted(self.variables.keys()):
            # æ·»åŠ æè¿°è¨»è§£
            if self._is_sensitive(key):
                lines.append(f"# {key} - Sensitive: Use a secure value")
            else:
                lines.append(f"# {key}")

            # æ·»åŠ ç¯„ä¾‹å€¼ï¼ˆç©ºå€¼æˆ–ä½”ä½ç¬¦ï¼‰
            if self._is_sensitive(key):
                lines.append(f"{key}=your_{key.lower()}_here")
            else:
                lines.append(f"{key}=")

            lines.append("")

        output_path = Path(output_file)
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write('\n'.join(lines))

        print(f"âœ“ å·²ç”Ÿæˆç¯„æœ¬: {output_file}")

    def check_security(self) -> List[Dict]:
        """å®‰å…¨æª¢æŸ¥"""
        issues = []

        # æª¢æŸ¥æ–‡ä»¶æ¬Šé™
        if self.env_file.exists():
            stat = self.env_file.stat()
            mode = stat.st_mode

            if mode & 0o044:  # å…¶ä»–ç”¨æˆ¶å¯è®€
                issues.append({
                    'severity': 'high',
                    'message': f'{self.env_file} å°å…¶ä»–ç”¨æˆ¶å¯è®€',
                    'recommendation': f'åŸ·è¡Œ: chmod 600 {self.env_file}'
                })

        # æª¢æŸ¥æ•æ„Ÿè®Šé‡
        for key, value in self.variables.items():
            if self._is_sensitive(key):
                # æª¢æŸ¥å¼±å¯†ç¢¼
                if len(value) < 12:
                    issues.append({
                        'severity': 'medium',
                        'message': f'{key} çš„å€¼éçŸ­',
                        'recommendation': 'ä½¿ç”¨è‡³å°‘ 12 å€‹å­—ç¬¦çš„å¼·å¯†ç¢¼'
                    })

                # æª¢æŸ¥ç°¡å–®å¯†ç¢¼
                if value.lower() in ['password', '123456', 'admin', 'root']:
                    issues.append({
                        'severity': 'critical',
                        'message': f'{key} ä½¿ç”¨äº†å¼±å¯†ç¢¼',
                        'recommendation': 'ä½¿ç”¨å¼·å¯†ç¢¼'
                    })

        # æª¢æŸ¥æ˜¯å¦åœ¨ .gitignore ä¸­
        gitignore = Path('.gitignore')
        if gitignore.exists():
            with open(gitignore, 'r') as f:
                content = f.read()
                if '.env' not in content:
                    issues.append({
                        'severity': 'high',
                        'message': '.env æœªåœ¨ .gitignore ä¸­',
                        'recommendation': 'æ·»åŠ  .env åˆ° .gitignore'
                    })
        else:
            issues.append({
                'severity': 'medium',
                'message': 'æœªæ‰¾åˆ° .gitignore æ–‡ä»¶',
                'recommendation': 'å‰µå»º .gitignore ä¸¦æ·»åŠ  .env'
            })

        return issues

    def compare(self, other_file: str):
        """æ¯”è¼ƒå…©å€‹ .env æ–‡ä»¶"""
        other = EnvManager(other_file)
        other.load()

        current_vars = set(self.variables.keys())
        other_vars = set(other.variables.keys())

        only_current = current_vars - other_vars
        only_other = other_vars - current_vars
        common = current_vars & other_vars

        print(f"\næ¯”è¼ƒ {self.env_file} å’Œ {other_file}:")
        print("="*60)

        if only_current:
            print(f"\nåƒ…åœ¨ {self.env_file}:")
            for var in sorted(only_current):
                print(f"  + {var}")

        if only_other:
            print(f"\nåƒ…åœ¨ {other_file}:")
            for var in sorted(only_other):
                print(f"  - {var}")

        if common:
            print(f"\nå…±åŒè®Šé‡ ({len(common)}):")
            different = []
            for var in sorted(common):
                if self.variables[var] != other.variables[var]:
                    different.append(var)

            if different:
                print(f"  å€¼ä¸åŒçš„è®Šé‡:")
                for var in different:
                    print(f"    â€¢ {var}")
            else:
                print("  æ‰€æœ‰å€¼éƒ½ç›¸åŒ")

    def export_to_shell(self):
        """å°å‡ºç‚º shell è…³æœ¬"""
        lines = ["#!/bin/bash", "# Auto-generated environment variables", ""]

        for key, value in sorted(self.variables.items()):
            # è½‰ç¾©ç‰¹æ®Šå­—ç¬¦
            value = value.replace('"', '\\"')
            lines.append(f'export {key}="{value}"')

        return '\n'.join(lines)

    def _is_sensitive(self, key: str) -> bool:
        """æª¢æŸ¥æ˜¯å¦ç‚ºæ•æ„Ÿè®Šé‡"""
        sensitive_keywords = [
            'password', 'secret', 'key', 'token', 'api',
            'auth', 'credential', 'private', 'pass'
        ]
        key_lower = key.lower()
        return any(keyword in key_lower for keyword in sensitive_keywords)


def main():
    """ä¸»å‡½æ•¸"""
    parser = argparse.ArgumentParser(
        description="ç’°å¢ƒè®Šé‡ç®¡ç†å·¥å…· - ç®¡ç†å’Œé©—è­‰ç’°å¢ƒè®Šé‡é…ç½®",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¯„ä¾‹:
  %(prog)s list                          # åˆ—å‡ºæ‰€æœ‰è®Šé‡
  %(prog)s list --show-values            # åˆ—å‡ºè®Šé‡åŠå…¶å€¼
  %(prog)s set DB_HOST localhost         # è¨­ç½®è®Šé‡
  %(prog)s get DB_HOST                   # ç²å–è®Šé‡
  %(prog)s delete OLD_VAR                # åˆªé™¤è®Šé‡
  %(prog)s validate --required DB_HOST,DB_PORT  # é©—è­‰å¿…éœ€è®Šé‡
  %(prog)s template                      # ç”Ÿæˆç¯„æœ¬æ–‡ä»¶
  %(prog)s security                      # å®‰å…¨æª¢æŸ¥
  %(prog)s compare .env.production       # æ¯”è¼ƒç’°å¢ƒæ–‡ä»¶
        """
    )

    parser.add_argument('command',
                       choices=['list', 'set', 'get', 'delete', 'validate',
                               'template', 'security', 'compare', 'export'],
                       help='è¦åŸ·è¡Œçš„å‘½ä»¤')
    parser.add_argument('args', nargs='*', help='å‘½ä»¤åƒæ•¸')
    parser.add_argument('--env-file', default='.env',
                       help='.env æ–‡ä»¶è·¯å¾‘ï¼ˆé è¨­: .envï¼‰')
    parser.add_argument('--show-values', action='store_true',
                       help='é¡¯ç¤ºè®Šé‡å€¼')
    parser.add_argument('--required', help='å¿…éœ€çš„è®Šé‡ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰')
    parser.add_argument('--output', '-o', help='è¼¸å‡ºæ–‡ä»¶è·¯å¾‘')

    args = parser.parse_args()

    manager = EnvManager(env_file=args.env_file)

    try:
        # å°æ–¼å¤§å¤šæ•¸å‘½ä»¤ï¼Œå…ˆåŠ è¼‰ç¾æœ‰è®Šé‡
        if args.command != 'template':
            manager.load()

        if args.command == 'list':
            manager.list_vars(show_values=args.show_values)

        elif args.command == 'set':
            if len(args.args) < 2:
                print("éŒ¯èª¤: éœ€è¦è®Šé‡åå’Œå€¼", file=sys.stderr)
                sys.exit(1)
            key, value = args.args[0], ' '.join(args.args[1:])
            manager.set_var(key, value)
            manager.save()

        elif args.command == 'get':
            if not args.args:
                print("éŒ¯èª¤: éœ€è¦è®Šé‡å", file=sys.stderr)
                sys.exit(1)
            key = args.args[0]
            value = manager.get_var(key)
            if value is not None:
                print(f"{key}={value}")
            else:
                print(f"éŒ¯èª¤: {key} ä¸å­˜åœ¨", file=sys.stderr)
                sys.exit(1)

        elif args.command == 'delete':
            if not args.args:
                print("éŒ¯èª¤: éœ€è¦è®Šé‡å", file=sys.stderr)
                sys.exit(1)
            key = args.args[0]
            manager.delete_var(key)
            manager.save()

        elif args.command == 'validate':
            required = args.required.split(',') if args.required else []
            valid = manager.validate(required=required)
            sys.exit(0 if valid else 1)

        elif args.command == 'template':
            output = args.output or '.env.example'
            if not manager.variables:
                manager.load()  # å˜—è©¦åŠ è¼‰ç¾æœ‰è®Šé‡
            if manager.variables:
                manager.generate_template(output)
            else:
                print("è­¦å‘Š: æ²’æœ‰è®Šé‡å¯ä»¥ç”Ÿæˆç¯„æœ¬", file=sys.stderr)

        elif args.command == 'security':
            issues = manager.check_security()
            if issues:
                print("\nğŸ”’ å®‰å…¨æª¢æŸ¥çµæœ:")
                print("="*60)
                for issue in issues:
                    severity = issue['severity'].upper()
                    print(f"\n[{severity}] {issue['message']}")
                    print(f"  ğŸ’¡ å»ºè­°: {issue['recommendation']}")
                sys.exit(1 if any(i['severity'] in ['critical', 'high'] for i in issues) else 0)
            else:
                print("âœ“ æœªç™¼ç¾å®‰å…¨å•é¡Œ")

        elif args.command == 'compare':
            if not args.args:
                print("éŒ¯èª¤: éœ€è¦è¦æ¯”è¼ƒçš„æ–‡ä»¶è·¯å¾‘", file=sys.stderr)
                sys.exit(1)
            manager.compare(args.args[0])

        elif args.command == 'export':
            script = manager.export_to_shell()
            if args.output:
                with open(args.output, 'w') as f:
                    f.write(script)
                print(f"âœ“ å·²å°å‡ºåˆ° {args.output}")
            else:
                print(script)

    except Exception as e:
        print(f"\néŒ¯èª¤: {e}", file=sys.stderr)
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == '__main__':
    main()
