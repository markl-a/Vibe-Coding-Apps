# FreeRTOS é›»æºç®¡ç†ç¯„ä¾‹

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®éŒ„åŒ…å« FreeRTOS åœ¨åµŒå…¥å¼ç³»çµ±ä¸­å¯¦ç¾ä½åŠŸè€—çš„å®Œæ•´ç¯„ä¾‹ã€‚é€™äº›ç¯„ä¾‹å±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ FreeRTOS çš„ Tickless Idle æ¨¡å¼å’Œ STM32 çš„ä½åŠŸè€—ç‰¹æ€§ä¾†å¤§å¹…é™ä½ç³»çµ±åŠŸè€—ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. Tickless Idle æ¨¡å¼
- **è‡ªå‹•ä½åŠŸè€—**: ç•¶ç³»çµ±ç©ºé–’æ™‚è‡ªå‹•é€²å…¥ä½åŠŸè€—æ¨¡å¼
- **å‹•æ…‹å–šé†’**: ä½¿ç”¨ RTC å®šæ™‚å™¨åœ¨éœ€è¦æ™‚å–šé†’ç³»çµ±
- **é€æ˜å¯¦ç¾**: å°æ‡‰ç”¨å±¤ä»»å‹™å®Œå…¨é€æ˜

### 2. å¤šç¨®ä½åŠŸè€—æ¨¡å¼
- **Sleep æ¨¡å¼**: CPU åœæ­¢ï¼Œå¤–è¨­ç¹¼çºŒé‹è¡Œ (~50mA)
- **Stop æ¨¡å¼**: CPU å’Œå¤§éƒ¨åˆ†å¤–è¨­åœæ­¢ (~200Î¼A)
- **Standby æ¨¡å¼**: æœ€ä½åŠŸè€—ï¼Œç³»çµ±é‡å•Ÿ (~2Î¼A)

### 3. å‹•æ…‹é›»å£“å’Œé »ç‡èª¿æ•´ (DVFS)
- æ ¹æ“šè² è¼‰å‹•æ…‹èª¿æ•´ CPU é »ç‡
- é™ä½é »ç‡ä»¥ç¯€çœåŠŸè€—
- è‡ªå‹•æ¢å¾©æ­£å¸¸é »ç‡

### 4. å¤–è¨­é›»æºç®¡ç†
- ç¦ç”¨æœªä½¿ç”¨çš„å¤–è¨­æ™‚é˜
- é…ç½®æœªä½¿ç”¨çš„ GPIO ç‚ºæ¨¡æ“¬è¼¸å…¥
- æ™ºèƒ½å¤–è¨­å–šé†’

## ğŸ“ æ–‡ä»¶èªªæ˜

```
06-power-management/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ low_power_modes.c           # ä½åŠŸè€—æ¨¡å¼å¯¦ç¾
â”œâ”€â”€ tickless_config.h           # Tickless é…ç½®
â”œâ”€â”€ power_profile.c             # åŠŸè€—åˆ†æå·¥å…·
â””â”€â”€ wakeup_sources.c            # å–šé†’æºé…ç½®
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```c
#include "low_power_modes.h"

int main(void)
{
    /* HAL åˆå§‹åŒ– */
    HAL_Init();
    SystemClock_Config();

    /* åˆå§‹åŒ–ä½åŠŸè€—ç¤ºç¯„ */
    low_power_demo_init();

    /* å•Ÿå‹• FreeRTOS */
    vTaskStartScheduler();

    while (1);
}
```

### 2. å•Ÿç”¨ Tickless Idle

åœ¨ `FreeRTOSConfig.h` ä¸­æ·»åŠ ï¼š

```c
/* å•Ÿç”¨ Tickless Idle */
#define configUSE_TICKLESS_IDLE             1

/* é…ç½®é æœŸç©ºé–’æ™‚é–“é–¾å€¼ï¼ˆticksï¼‰ */
#define configEXPECTED_IDLE_TIME_BEFORE_SLEEP   2

/* å®šç¾©ç¡çœ å‡½æ•¸ */
extern void vApplicationSleep(TickType_t xExpectedIdleTime);
#define portSUPPRESS_TICKS_AND_SLEEP(xExpectedIdleTime) \
    vApplicationSleep(xExpectedIdleTime)
```

### 3. é…ç½® RTC ç”¨æ–¼ Tickless

```c
static void RTC_Init(void)
{
    hrtc.Instance = RTC;
    hrtc.Init.HourFormat = RTC_HOURFORMAT_24;
    hrtc.Init.AsynchPrediv = 127;
    hrtc.Init.SynchPrediv = 255;

    HAL_RTC_Init(&hrtc);
}
```

## ğŸ’¡ ä½¿ç”¨ç¯„ä¾‹

### ç¯„ä¾‹ 1: é€±æœŸæ€§æ„Ÿæ¸¬å™¨è®€å–ï¼ˆä½åŠŸè€—ï¼‰

```c
void vSensorTask(void *pvParameters)
{
    while (1) {
        /* è®€å–æ„Ÿæ¸¬å™¨ */
        float temp = read_temperature();

        /* è™•ç†æ•¸æ“š */
        process_data(temp);

        /* é•·æ™‚é–“ç¡çœ ï¼Œç³»çµ±è‡ªå‹•é€²å…¥ä½åŠŸè€— */
        vTaskDelay(pdMS_TO_TICKS(5000));  // 5ç§’
    }
}
```

### ç¯„ä¾‹ 2: æŒ‰éœ€å–šé†’

```c
void vControlTask(void *pvParameters)
{
    while (1) {
        /* ç­‰å¾…äº‹ä»¶ï¼ˆå¯è¢«ä¸­æ–·å–šé†’ï¼‰ */
        ulTaskNotifyTake(pdTRUE, portMAX_DELAY);

        /* è™•ç†å–šé†’äº‹ä»¶ */
        handle_wakeup_event();
    }
}

/* GPIO ä¸­æ–·ï¼ˆæŒ‰éˆ•æŒ‰ä¸‹ï¼‰ */
void EXTI0_IRQHandler(void)
{
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    vTaskNotifyGiveFromISR(control_task_handle, &xHigherPriorityTaskWoken);
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}
```

### ç¯„ä¾‹ 3: å‹•æ…‹é »ç‡èª¿æ•´

```c
void vAdaptiveTask(void *pvParameters)
{
    while (1) {
        /* ç²å–ç³»çµ±è² è¼‰ */
        uint32_t load = get_system_load();

        if (load < 30) {
            /* ä½è² è¼‰ï¼Œé™ä½é »ç‡ */
            DVFS_LowerFrequency();
        } else if (load > 70) {
            /* é«˜è² è¼‰ï¼Œæ¢å¾©é »ç‡ */
            DVFS_RestoreFrequency();
        }

        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}
```

## ğŸ“Š åŠŸè€—æ¸¬é‡

### STM32F407VG å…¸å‹åŠŸè€—

| æ¨¡å¼ | CPU | å¤–è¨­ | åŠŸè€— | å–šé†’æ™‚é–“ |
|------|-----|------|------|---------|
| Run @ 168MHz | ON | ON | ~100mA | N/A |
| Sleep | OFF | ON | ~50mA | <1Î¼s |
| Stop | OFF | OFF | ~200Î¼A | ~5Î¼s |
| Standby | OFF | OFF | ~2Î¼A | ~50Î¼s |

### å¯¦æ¸¬æ•¸æ“š

ä½¿ç”¨ç¤ºç¯„ç¨‹å¼ï¼Œé€±æœŸ 5 ç§’è®€å–ä¸€æ¬¡æ„Ÿæ¸¬å™¨ï¼š

- **ç„¡ä½åŠŸè€—å„ªåŒ–**: å¹³å‡åŠŸè€— ~100mA
- **å•Ÿç”¨ Sleep æ¨¡å¼**: å¹³å‡åŠŸè€— ~15mA (ç¯€çœ 85%)
- **å•Ÿç”¨ Stop æ¨¡å¼**: å¹³å‡åŠŸè€— ~2mA (ç¯€çœ 98%)

## ğŸ”§ é…ç½®é¸é …

### åœ¨ `tickless_config.h` ä¸­é…ç½®

```c
/* ä½åŠŸè€—æ¨¡å¼é¸æ“‡ */
#define LOW_POWER_MODE          POWER_MODE_STOP

/* RTC å–šé†’å®šæ™‚å™¨æ™‚é˜æº */
#define RTC_CLOCK_SOURCE        RTC_CLOCK_LSE  // æˆ– LSI

/* æœ€å°ç¡çœ æ™‚é–“ï¼ˆmsï¼‰ */
#define MIN_SLEEP_TIME_MS       2

/* æ·±åº¦ç¡çœ é–¾å€¼ï¼ˆmsï¼‰ */
#define DEEP_SLEEP_THRESHOLD_MS 1000
```

## âš ï¸ æ³¨æ„äº‹é …

### 1. æ™‚é˜é…ç½®
- Stop æ¨¡å¼æœƒåœæ­¢ HSEï¼Œå–šé†’å¾Œéœ€é‡æ–°é…ç½®æ™‚é˜
- ç¢ºä¿åœ¨å–šé†’å¾Œèª¿ç”¨ `SystemClock_Config()`

### 2. å¤–è¨­ç‹€æ…‹
- é€²å…¥ Stop æ¨¡å¼å‰ï¼Œç¢ºä¿æ‰€æœ‰å¤–è¨­è™•æ–¼å®‰å…¨ç‹€æ…‹
- UART å‚³è¼¸æ‡‰å®Œæˆ
- SPI/I2C å‚³è¼¸æ‡‰å®Œæˆ

### 3. èª¿è©¦å›°é›£
- Stop/Standby æ¨¡å¼æœƒæ–·é–‹èª¿è©¦å™¨é€£æ¥
- é–‹ç™¼æ™‚å¯æš«æ™‚ç¦ç”¨æ·±åº¦ç¡çœ 
- ä½¿ç”¨ LED æˆ– UART è¼¸å‡ºèª¿è©¦ä¿¡æ¯

### 4. RTC æ™‚é˜æºé¸æ“‡
- **LSE (32.768kHz)**: ç²¾ç¢ºï¼ŒåŠŸè€—ä½ï¼Œéœ€å¤–éƒ¨æ™¶æŒ¯
- **LSI (~32kHz)**: å…§éƒ¨ï¼Œç„¡éœ€å¤–éƒ¨å…ƒä»¶ï¼Œç²¾åº¦è¼ƒä½

## ğŸ§ª æ¸¬è©¦ç¨‹åº

### 1. åŸºæœ¬åŠŸèƒ½æ¸¬è©¦

```bash
# ç·¨è­¯
make clean && make

# ç‡’éŒ„
make flash

# ç›£æ§ä¸²å£è¼¸å‡º
minicom -D /dev/ttyUSB0 -b 115200
```

### 2. åŠŸè€—æ¸¬é‡

1. æ–·é–‹ ST-Link çš„é›»æºé€£æ¥
2. ä½¿ç”¨é›»æµè¡¨ä¸²è¯åœ¨ VDD å’Œé›»æºä¹‹é–“
3. è§€å¯Ÿä¸åŒæ¨¡å¼ä¸‹çš„é›»æµè®€æ•¸

### 3. é©—è­‰å–šé†’åŠŸèƒ½

- æ¸¬è©¦ RTC å®šæ™‚å–šé†’
- æ¸¬è©¦ GPIO å¤–éƒ¨ä¸­æ–·å–šé†’
- æ¸¬è©¦ UART æ¥æ”¶å–šé†’

## ğŸ“š ç›¸é—œè³‡æº

### å®˜æ–¹æ–‡æª”
- [FreeRTOS Tickless Idle](https://www.freertos.org/low-power-tickless-rtos.html)
- [STM32F4 ä½åŠŸè€—æ¨¡å¼](https://www.st.com/resource/en/application_note/dm00083249.pdf)
- [STM32 RTC æ‡‰ç”¨ç­†è¨˜](https://www.st.com/resource/en/application_note/dm00226326.pdf)

### æ‡‰ç”¨ç­†è¨˜
- AN4365: STM32F4 ä½åŠŸè€—æ‡‰ç”¨
- AN4656: STM32F4 æ™‚é˜é…ç½®å·¥å…·
- AN4991: STM32 é›»æ± ä¾›é›»æ‡‰ç”¨

## ğŸ” æ•…éšœæ’é™¤

### Q: ç³»çµ±ç„¡æ³•å¾ Stop æ¨¡å¼å–šé†’
**A**: æª¢æŸ¥ RTC ä¸­æ–·æ˜¯å¦æ­£ç¢ºé…ç½®ï¼Œç¢ºä¿ NVIC å•Ÿç”¨äº† RTC_WKUP_IRQn

### Q: å–šé†’å¾Œç³»çµ±é‹è¡Œç•°å¸¸
**A**: ç¢ºä¿åœ¨å–šé†’å¾Œé‡æ–°é…ç½®äº†ç³»çµ±æ™‚é˜ï¼ˆ`SystemClock_Config()`ï¼‰

### Q: Tickless Idle æ²’æœ‰æ•ˆæœ
**A**: æª¢æŸ¥ `FreeRTOSConfig.h` ä¸­ `configUSE_TICKLESS_IDLE` æ˜¯å¦ç‚º 1

### Q: åŠŸè€—ä»ç„¶å¾ˆé«˜
**A**:
1. æª¢æŸ¥æ˜¯å¦ç¦ç”¨äº†æ‰€æœ‰æœªä½¿ç”¨çš„å¤–è¨­æ™‚é˜
2. ç¢ºä¿æœªä½¿ç”¨çš„ GPIO é…ç½®ç‚ºæ¨¡æ“¬è¼¸å…¥
3. æª¢æŸ¥æ˜¯å¦æœ‰å¤–è¨­æŒçºŒé‹è¡Œé˜»æ­¢é€²å…¥ä½åŠŸè€—æ¨¡å¼

## ğŸ“ æœ€ä½³å¯¦è¸

### 1. ä»»å‹™è¨­è¨ˆ
- ä½¿ç”¨é•·å»¶é²æ™‚é–“ï¼ˆvTaskDelayï¼‰è®“ç³»çµ±æœ‰æ©Ÿæœƒé€²å…¥ä½åŠŸè€—
- é¿å…å¿™ç­‰å¾…ï¼ˆbusy-waitï¼‰
- ä½¿ç”¨äº‹ä»¶é©…å‹•è€Œéè¼ªè©¢

### 2. ä¸­æ–·å„ªåŒ–
- ISR æ‡‰ç›¡å¯èƒ½çŸ­
- ä½¿ç”¨ FreeRTOS çš„ FromISR API
- é¿å…åœ¨ ISR ä¸­é€²è¡Œè¤‡é›œè™•ç†

### 3. æ™‚é˜ç®¡ç†
- æ ¹æ“šè² è¼‰å‹•æ…‹èª¿æ•´é »ç‡
- å¤–è¨­æ™‚é˜æŒ‰éœ€å•Ÿç”¨/ç¦ç”¨
- ä½¿ç”¨ä½åŠŸè€—å®šæ™‚å™¨ï¼ˆLPTIMï¼‰

### 4. åŠŸè€—æ¸¬è©¦
- åœ¨å¯¦éš›ç¡¬ä»¶ä¸Šæ¸¬é‡åŠŸè€—
- è€ƒæ…®æº«åº¦å°åŠŸè€—çš„å½±éŸ¿
- æ¸¬è©¦ä¸åŒä½¿ç”¨å ´æ™¯çš„åŠŸè€—

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

### ç›®æ¨™åŠŸè€—ï¼ˆé›»æ± ä¾›é›»æ‡‰ç”¨ï¼‰

| æ‡‰ç”¨å ´æ™¯ | å¹³å‡åŠŸè€— | é›»æ± å£½å‘½ (2000mAh) |
|---------|---------|-------------------|
| é«˜é »æ•¸æ“šæ¡é›† (1Hz) | ~10mA | ~8 å¤© |
| ä¸­é »æ•¸æ“šæ¡é›† (0.2Hz) | ~2mA | ~40 å¤© |
| ä½é »æ•¸æ“šæ¡é›† (0.01Hz) | ~500Î¼A | ~160 å¤© |
| å¾…æ©Ÿæ¨¡å¼ | ~50Î¼A | ~4.5 å¹´ |

## ğŸš€ é€²éšä¸»é¡Œ

### 1. å¤šç´šé›»æºç®¡ç†ç­–ç•¥
- æ ¹æ“šé›»æ± é›»é‡å‹•æ…‹èª¿æ•´ç­–ç•¥
- å¯¦ç¾æ™ºèƒ½å–šé†’é »ç‡èª¿æ•´
- ç·Šæ€¥æ¨¡å¼è™•ç†

### 2. AI è¼”åŠ©é›»æºå„ªåŒ–
- ä½¿ç”¨æ©Ÿå™¨å­¸ç¿’é æ¸¬ç³»çµ±è¡Œç‚º
- å‹•æ…‹èª¿æ•´ç¡çœ ç­–ç•¥
- è‡ªé©æ‡‰é »ç‡èª¿æ•´

### 3. èƒ½é‡æ”¶é›†é›†æˆ
- å¤ªé™½èƒ½å……é›»ç®¡ç†
- å‹•èƒ½æ”¶é›†
- ç†±é›»ç™¼é›»

---

**ä½œè€…**: AI-Assisted Development Team
**æ›´æ–°æ—¥æœŸ**: 2025-11-18
**ç‰ˆæœ¬**: 1.0.0
**æˆæ¬Š**: MIT License
