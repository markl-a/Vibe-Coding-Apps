# OpenOCD 配置文件 - RTOS 除錯
# 適用於 STM32F4 Discovery 開發板
# 作者: AI-Assisted Development Team
# 日期: 2025-11-18

# ==================== 調試器接口 ====================

# 使用 ST-Link/V2 調試器
source [find interface/stlink.cfg]

# 設置 SWD 模式（Serial Wire Debug）
transport select hla_swd

# 調試器速度（kHz）
# 初始速度較慢以確保穩定連接
adapter speed 1000

# ==================== 目標配置 ====================

# STM32F4x 目標
source [find target/stm32f4x.cfg]

# ==================== RTOS 支援 ====================

# 啟用 FreeRTOS 支援
# OpenOCD 可以解析 FreeRTOS 任務列表
# $_TARGETNAME configure -rtos FreeRTOS

# 啟用 Zephyr 支援
# $_TARGETNAME configure -rtos Zephyr

# ==================== 調試選項 ====================

# 啟用 semihosting（用於 printf 輸出到 OpenOCD 控制台）
# arm semihosting enable

# GDB 端口
gdb_port 3333

# Telnet 端口
telnet_port 4444

# TCL 端口
tcl_port 6666

# ==================== 初始化腳本 ====================

# 重置後執行的命令
$_TARGETNAME configure -event reset-init {
    # 停止看門狗（如果需要）
    # mww 0x40023C00 0x00000000

    # 配置時鐘（可選，通常由固件處理）
    # ...

    # 啟用 DWT 和 ITM（用於追蹤）
    # Enable DWT
    mww 0xE0001000 0x40000001

    # Enable Trace
    mww 0xE0000FB0 0xC5ACCE55

    echo "Target initialized"
}

# 連接後執行
$_TARGETNAME configure -event gdb-attach {
    echo "GDB connected"
    halt
}

# 斷開連接時執行
$_TARGETNAME configure -event gdb-detach {
    echo "GDB disconnected"
    resume
}

# ==================== 燒錄配置 ====================

# Flash 配置
# flash bank <name> <driver> <base> <size> <chip_width> <bus_width> <target>
# STM32F407VG 有 1MB Flash
set _FLASHNAME $_CHIPNAME.flash
flash bank $_FLASHNAME stm32f2x 0x08000000 0x100000 0 0 $_TARGETNAME

# ==================== 自定義命令 ====================

# 完整復位
proc full_reset {} {
    reset halt
    wait_halt
    echo "Full reset complete"
}

# 燒錄固件
proc flash_firmware {filename} {
    reset halt
    wait_halt

    echo "Erasing flash..."
    flash erase_sector 0 0 last

    echo "Programming $filename..."
    flash write_image $filename 0x08000000

    echo "Verifying..."
    verify_image $filename 0x08000000

    echo "Resetting..."
    reset run

    echo "Firmware flashed successfully!"
}

# 讀取記憶體區域
proc dump_memory {filename address size} {
    echo "Dumping memory: $address, size: $size"
    dump_image $filename $address $size
    echo "Memory dumped to $filename"
}

# 顯示系統信息
proc show_info {} {
    echo "Target Information:"
    echo "=================="

    # CPU 信息
    set cpuid [mrw 0xE000ED00]
    echo "CPUID: [format 0x%08X $cpuid]"

    # Flash 大小
    set flash_size [mrh 0x1FFF7A22]
    echo "Flash Size: [expr {$flash_size}] KB"

    # SRAM 大小（STM32F407VG 有 192KB）
    echo "SRAM Size: 192 KB"

    # 設備 ID
    set dev_id [mrw 0xE0042000]
    echo "Device ID: [format 0x%08X $dev_id]"
}

# ==================== ITM/SWO 配置 ====================

# 配置 ITM（Instrumentation Trace Macrocell）
# 用於 printf 除錯輸出
proc enable_itm {baudrate} {
    # Enable TPIU and ITM
    mww 0xE0040010 0x00000001
    mww 0xE00400F0 0x00000002
    mww 0xE0040304 [expr {$baudrate - 1}]

    # Enable ITM stimulus port 0
    mww 0xE0000E00 0x00000001
    mww 0xE0000E80 0x00000001

    # Enable ITM
    mww 0xE0000E00 0x00010001

    echo "ITM enabled at $baudrate baud"
}

# ==================== RTT 配置 ====================

# SEGGER RTT（Real-Time Transfer）配置
# 更快的除錯輸出方式
proc enable_rtt {} {
    # RTT 控制塊地址（需要根據實際情況調整）
    # set rtt_addr [expr {[lindex [find_rtt_control_block] 0]}]
    # rtt setup $rtt_addr 0x1000 "SEGGER RTT"
    # rtt start
    echo "RTT configuration (requires SEGGER RTT library)"
}

# ==================== FreeRTOS 助手 ====================

# 顯示 FreeRTOS 任務列表
proc freertos_tasks {} {
    echo "FreeRTOS Tasks:"
    echo "==============="

    # 需要讀取 pxReadyTasksLists 等變量
    # 這需要符號信息
    echo "(Requires GDB with FreeRTOS awareness)"
}

# ==================== 歡迎信息 ====================

echo ""
echo "╔═══════════════════════════════════════════════╗"
echo "║        OpenOCD RTOS Debug Configuration       ║"
echo "╚═══════════════════════════════════════════════╝"
echo ""
echo "Available commands:"
echo "  full_reset              - Perform full target reset"
echo "  flash_firmware <file>   - Flash firmware to target"
echo "  dump_memory <f> <a> <s> - Dump memory region"
echo "  show_info               - Display target information"
echo "  enable_itm <baud>       - Enable ITM trace output"
echo "  enable_rtt              - Enable SEGGER RTT"
echo ""
echo "GDB port: 3333"
echo "Telnet port: 4444"
echo ""
