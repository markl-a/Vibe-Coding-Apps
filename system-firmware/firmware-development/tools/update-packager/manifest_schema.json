{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "OTA Update Manifest",
  "description": "Manifest schema for OTA firmware update packages",
  "type": "object",
  "required": [
    "version",
    "package_type",
    "firmware_version",
    "build_date",
    "target_device",
    "files",
    "checksums"
  ],
  "properties": {
    "version": {
      "type": "string",
      "description": "Manifest format version",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "default": "1.0.0"
    },
    "package_type": {
      "type": "string",
      "description": "Type of update package",
      "enum": ["full", "delta", "incremental"]
    },
    "firmware_version": {
      "type": "object",
      "required": ["major", "minor", "patch", "build"],
      "properties": {
        "major": {
          "type": "integer",
          "minimum": 0
        },
        "minor": {
          "type": "integer",
          "minimum": 0
        },
        "patch": {
          "type": "integer",
          "minimum": 0
        },
        "build": {
          "type": "integer",
          "minimum": 0
        },
        "version_string": {
          "type": "string",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$"
        }
      }
    },
    "build_date": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of package creation"
    },
    "target_device": {
      "type": "object",
      "required": ["model", "hardware_version"],
      "properties": {
        "model": {
          "type": "string",
          "description": "Target device model identifier"
        },
        "hardware_version": {
          "type": "string",
          "description": "Compatible hardware version"
        },
        "min_firmware_version": {
          "type": "string",
          "description": "Minimum firmware version required for this update"
        },
        "max_firmware_version": {
          "type": "string",
          "description": "Maximum firmware version compatible with this update"
        }
      }
    },
    "ab_update": {
      "type": "object",
      "description": "A/B partition update configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "target_slot": {
          "type": "string",
          "enum": ["auto", "A", "B"],
          "default": "auto"
        },
        "verify_before_reboot": {
          "type": "boolean",
          "default": true
        },
        "fallback_enabled": {
          "type": "boolean",
          "default": true
        }
      }
    },
    "files": {
      "type": "array",
      "description": "List of files included in the update package",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["name", "size", "checksum", "type"],
        "properties": {
          "name": {
            "type": "string",
            "description": "File name within the package"
          },
          "path": {
            "type": "string",
            "description": "Installation path on target device"
          },
          "size": {
            "type": "integer",
            "minimum": 0,
            "description": "File size in bytes"
          },
          "compressed_size": {
            "type": "integer",
            "minimum": 0,
            "description": "Compressed size in bytes"
          },
          "checksum": {
            "type": "string",
            "pattern": "^[a-fA-F0-9]{64}$",
            "description": "SHA-256 checksum"
          },
          "type": {
            "type": "string",
            "enum": ["firmware", "bootloader", "kernel", "rootfs", "data", "patch"],
            "description": "File type"
          },
          "compression": {
            "type": "string",
            "enum": ["none", "gzip", "zlib", "lzma", "bzip2"],
            "default": "gzip"
          },
          "partition": {
            "type": "string",
            "description": "Target partition name"
          },
          "offset": {
            "type": "integer",
            "minimum": 0,
            "description": "Offset within the package"
          }
        }
      }
    },
    "checksums": {
      "type": "object",
      "required": ["algorithm", "package_checksum"],
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["sha256", "sha512"],
          "default": "sha256"
        },
        "package_checksum": {
          "type": "string",
          "description": "Checksum of entire package"
        },
        "manifest_checksum": {
          "type": "string",
          "description": "Checksum of manifest file itself"
        }
      }
    },
    "signature": {
      "type": "object",
      "description": "Digital signature information",
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["rsa2048", "rsa4096", "ecdsa"],
          "default": "rsa2048"
        },
        "signature": {
          "type": "string",
          "description": "Base64-encoded signature"
        },
        "public_key_fingerprint": {
          "type": "string",
          "description": "SHA-256 fingerprint of public key"
        },
        "signing_date": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "encryption": {
      "type": "object",
      "description": "Encryption configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false
        },
        "algorithm": {
          "type": "string",
          "enum": ["aes128", "aes256"],
          "default": "aes256"
        },
        "mode": {
          "type": "string",
          "enum": ["cbc", "gcm", "ctr"],
          "default": "gcm"
        }
      }
    },
    "delta_update": {
      "type": "object",
      "description": "Delta update specific information",
      "properties": {
        "source_version": {
          "type": "string",
          "description": "Source firmware version for delta"
        },
        "target_version": {
          "type": "string",
          "description": "Target firmware version"
        },
        "algorithm": {
          "type": "string",
          "enum": ["bsdiff", "xdelta3", "courgette"],
          "default": "bsdiff"
        },
        "patch_size": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "rollback_protection": {
      "type": "object",
      "description": "Rollback protection settings",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true
        },
        "minimum_version": {
          "type": "string",
          "description": "Minimum allowed firmware version"
        },
        "security_patch_level": {
          "type": "integer",
          "description": "Security patch level"
        }
      }
    },
    "pre_install": {
      "type": "object",
      "description": "Pre-installation checks and scripts",
      "properties": {
        "required_free_space": {
          "type": "integer",
          "minimum": 0,
          "description": "Required free space in bytes"
        },
        "battery_level": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Minimum battery level percentage"
        },
        "script": {
          "type": "string",
          "description": "Pre-installation script file name"
        }
      }
    },
    "post_install": {
      "type": "object",
      "description": "Post-installation actions",
      "properties": {
        "reboot_required": {
          "type": "boolean",
          "default": true
        },
        "script": {
          "type": "string",
          "description": "Post-installation script file name"
        },
        "verification_timeout": {
          "type": "integer",
          "minimum": 0,
          "description": "Verification timeout in seconds"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata",
      "properties": {
        "release_notes": {
          "type": "string"
        },
        "changelog": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "author": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
