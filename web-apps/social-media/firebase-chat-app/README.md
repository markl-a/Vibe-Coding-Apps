# Firebase å³æ™‚èŠå¤©æ‡‰ç”¨

ä½¿ç”¨ Next.js 14 å’Œ Firebase æ‰“é€ çš„ç¾ä»£åŒ–å³æ™‚èŠå¤©æ‡‰ç”¨ï¼Œæ”¯æ´ä¸€å°ä¸€èŠå¤©ã€ç¾¤çµ„èŠå¤©ã€æª”æ¡ˆåˆ†äº«ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹è‰²

- âœ¨ **ç¾è§€çš„ UI** - ç¾ä»£åŒ–èŠå¤©ä»‹é¢è¨­è¨ˆ
- âš¡ **å³æ™‚é€šè¨Š** - Firebase Firestore å³æ™‚è³‡æ–™åŒæ­¥
- ğŸ” **å®‰å…¨èªè­‰** - Firebase Authentication å¤šç¨®ç™»å…¥æ–¹å¼
- ğŸ‘¥ **ç¾¤çµ„èŠå¤©** - å»ºç«‹ç¾¤çµ„ã€é‚€è«‹æˆå“¡
- ğŸ“ **æª”æ¡ˆåˆ†äº«** - æ”¯æ´åœ–ç‰‡ã€å½±ç‰‡ã€æ–‡ä»¶ä¸Šå‚³
- ğŸ”” **å³æ™‚é€šçŸ¥** - æ–°è¨Šæ¯å³æ™‚æ¨é€
- âœ… **å·²è®€ç‹€æ…‹** - é¡¯ç¤ºè¨Šæ¯å·²è®€/æœªè®€
- ğŸ’¬ **æ­£åœ¨è¼¸å…¥** - é¡¯ç¤ºå°æ–¹æ­£åœ¨è¼¸å…¥ç‹€æ…‹
- ğŸ˜€ **è¡¨æƒ…ç¬¦è™Ÿ** - è±å¯Œçš„è¡¨æƒ…ç¬¦è™Ÿæ”¯æ´
- ğŸ“± **éŸ¿æ‡‰å¼è¨­è¨ˆ** - å®Œç¾æ”¯æ´å„ç¨®è£ç½®

## æ ¸å¿ƒåŠŸèƒ½

### 1. ç”¨æˆ¶èªè­‰
- Email/å¯†ç¢¼ç™»å…¥
- Google ç™»å…¥
- Facebook ç™»å…¥
- GitHub ç™»å…¥
- åŒ¿åç™»å…¥
- è¨˜ä½ç™»å…¥ç‹€æ…‹

### 2. ä¸€å°ä¸€èŠå¤©
- å³æ™‚è¨Šæ¯å‚³é€
- è¨Šæ¯å·²è®€ç‹€æ…‹
- æ­£åœ¨è¼¸å…¥æŒ‡ç¤ºå™¨
- è¨Šæ¯æœå°‹
- èŠå¤©è¨˜éŒ„ä¿å­˜

### 3. ç¾¤çµ„èŠå¤©
- å»ºç«‹ç¾¤çµ„
- é‚€è«‹æˆå“¡
- ç§»é™¤æˆå“¡
- è¨­å®šç®¡ç†å“¡
- ç¾¤çµ„è³‡è¨Šç·¨è¼¯
- ç¾¤çµ„é ­è²¼ä¸Šå‚³

### 4. æª”æ¡ˆåˆ†äº«
- åœ–ç‰‡ä¸Šå‚³èˆ‡é è¦½
- å½±ç‰‡ä¸Šå‚³èˆ‡æ’­æ”¾
- æ–‡ä»¶æª”æ¡ˆåˆ†äº«
- æª”æ¡ˆä¸‹è¼‰
- Firebase Storage å„²å­˜

### 5. é€šçŸ¥ç³»çµ±
- æ–°è¨Šæ¯æ¨é€
- ç€è¦½å™¨é€šçŸ¥
- æœªè®€è¨ˆæ•¸
- è²éŸ³æç¤º

### 6. ç”¨æˆ¶ç‹€æ…‹
- åœ¨ç·š/é›¢ç·šç‹€æ…‹
- æœ€å¾Œä¸Šç·šæ™‚é–“
- æ­£åœ¨è¼¸å…¥ç‹€æ…‹

## æŠ€è¡“æ£§

- **æ¡†æ¶**: Next.js 14 (App Router)
- **èªè¨€**: TypeScript
- **æ¨£å¼**: Tailwind CSS
- **å¾Œç«¯æœå‹™**: Firebase
  - Authenticationï¼ˆèªè­‰ï¼‰
  - Firestoreï¼ˆè³‡æ–™åº«ï¼‰
  - Storageï¼ˆæª”æ¡ˆå„²å­˜ï¼‰
  - Cloud Functionsï¼ˆé›²ç«¯å‡½å¼ï¼‰
- **ç‹€æ…‹ç®¡ç†**: Zustand
- **React Hooks**: react-firebase-hooks
- **æ—¥æœŸè™•ç†**: date-fns
- **åœ–ç¤º**: Lucide React
- **è¡¨æƒ…ç¬¦è™Ÿ**: emoji-picker-react
- **éƒ¨ç½²**: Vercel / Firebase Hosting

## å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

1. Node.js 18+
2. Firebase å°ˆæ¡ˆï¼ˆå‰å¾€ [Firebase Console](https://console.firebase.google.com/) å»ºç«‹ï¼‰

### Firebase è¨­å®š

1. å»ºç«‹ Firebase å°ˆæ¡ˆ
2. å•Ÿç”¨ Authentication æœå‹™
   - å•Ÿç”¨ Email/Password ç™»å…¥
   - å•Ÿç”¨ Google ç™»å…¥ï¼ˆå¯é¸ï¼‰
3. å»ºç«‹ Firestore è³‡æ–™åº«
4. å»ºç«‹ Storage å„²å­˜ç©ºé–“
5. å–å¾— Firebase é…ç½®è³‡è¨Š

### å®‰è£ä¾è³´

```bash
npm install
```

### ç’°å¢ƒè®Šæ•¸è¨­å®š

å»ºç«‹ `.env.local` æª”æ¡ˆï¼š

```bash
# Firebase é…ç½®
NEXT_PUBLIC_FIREBASE_API_KEY="your-api-key"
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="your-project.firebaseapp.com"
NEXT_PUBLIC_FIREBASE_PROJECT_ID="your-project-id"
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="your-project.appspot.com"
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="your-sender-id"
NEXT_PUBLIC_FIREBASE_APP_ID="your-app-id"
```

### Firestore å®‰å…¨è¦å‰‡

åœ¨ Firebase Console è¨­å®š Firestore å®‰å…¨è¦å‰‡ï¼š

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ç”¨æˆ¶è³‡æ–™
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // èŠå¤©å®¤
    match /chats/{chatId} {
      allow read, write: if request.auth != null &&
        request.auth.uid in resource.data.members;
    }

    // è¨Šæ¯
    match /chats/{chatId}/messages/{messageId} {
      allow read: if request.auth != null &&
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
      allow create: if request.auth != null;
    }
  }
}
```

### Storage å®‰å…¨è¦å‰‡

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /users/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    match /chats/{chatId}/{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

### é–‹ç™¼æ¨¡å¼

```bash
npm run dev
```

é–‹å•Ÿç€è¦½å™¨è¨ªå• [http://localhost:3000](http://localhost:3000)

### å»ºç½®ç”Ÿç”¢ç‰ˆæœ¬

```bash
npm run build
npm start
```

## å°ˆæ¡ˆçµæ§‹

```
firebase-chat-app/
â”œâ”€â”€ app/                        # Next.js App Router
â”‚   â”œâ”€â”€ layout.tsx             # æ ¹ä½ˆå±€
â”‚   â”œâ”€â”€ page.tsx               # é¦–é 
â”‚   â”œâ”€â”€ globals.css            # å…¨å±€æ¨£å¼
â”‚   â”œâ”€â”€ chat/                  # èŠå¤©é é¢
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ login/                 # ç™»å…¥é é¢
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ register/              # è¨»å†Šé é¢
â”‚       â””â”€â”€ page.tsx
â”œâ”€â”€ components/                # React çµ„ä»¶
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ ChatList.tsx      # èŠå¤©åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ ChatWindow.tsx    # èŠå¤©è¦–çª—
â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx # è¨Šæ¯æ°£æ³¡
â”‚   â”‚   â””â”€â”€ MessageInput.tsx  # è¨Šæ¯è¼¸å…¥
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ LoginForm.tsx     # ç™»å…¥è¡¨å–®
â”‚   â”‚   â””â”€â”€ RegisterForm.tsx  # è¨»å†Šè¡¨å–®
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ Button.tsx
â”‚       â””â”€â”€ Modal.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ firebase.ts           # Firebase åˆå§‹åŒ–
â”‚   â”œâ”€â”€ auth.ts               # èªè­‰ç›¸é—œå‡½å¼
â”‚   â”œâ”€â”€ firestore.ts          # Firestore æ“ä½œ
â”‚   â””â”€â”€ storage.ts            # Storage æ“ä½œ
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ chat.ts               # èŠå¤©å‹åˆ¥
â”‚   â”œâ”€â”€ message.ts            # è¨Šæ¯å‹åˆ¥
â”‚   â””â”€â”€ user.ts               # ç”¨æˆ¶å‹åˆ¥
â”œâ”€â”€ public/                    # éœæ…‹è³‡æº
â”œâ”€â”€ package.json
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tailwind.config.ts
```

## Firebase è³‡æ–™çµæ§‹

### Users Collection

```typescript
{
  uid: string;
  email: string;
  displayName: string;
  photoURL: string;
  status: 'online' | 'offline';
  lastSeen: Timestamp;
  createdAt: Timestamp;
}
```

### Chats Collection

```typescript
{
  id: string;
  type: 'direct' | 'group';
  members: string[];  // ç”¨æˆ¶ UID é™£åˆ—
  name?: string;      // ç¾¤çµ„åç¨±ï¼ˆåƒ…ç¾¤çµ„ï¼‰
  photoURL?: string;  // ç¾¤çµ„é ­è²¼ï¼ˆåƒ…ç¾¤çµ„ï¼‰
  lastMessage: {
    content: string;
    senderId: string;
    timestamp: Timestamp;
  };
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### Messages SubCollection

```typescript
{
  id: string;
  chatId: string;
  senderId: string;
  content: string;
  type: 'text' | 'image' | 'video' | 'file';
  fileURL?: string;
  fileName?: string;
  isRead: boolean;
  readBy: string[];  // å·²è®€ç”¨æˆ¶ UID é™£åˆ—
  timestamp: Timestamp;
}
```

## ä½¿ç”¨ Firebase Hooks

### å–å¾—èŠå¤©åˆ—è¡¨

```typescript
import { useCollection } from 'react-firebase-hooks/firestore';
import { collection, query, where } from 'firebase/firestore';
import { db } from '@/lib/firebase';

function ChatList({ userId }: { userId: string }) {
  const [chatsSnapshot, loading, error] = useCollection(
    query(
      collection(db, 'chats'),
      where('members', 'array-contains', userId)
    )
  );

  const chats = chatsSnapshot?.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));

  // æ¸²æŸ“èŠå¤©åˆ—è¡¨...
}
```

### ç™¼é€è¨Šæ¯

```typescript
import { addDoc, collection, serverTimestamp } from 'firebase/firestore';
import { db } from '@/lib/firebase';

async function sendMessage(chatId: string, content: string, senderId: string) {
  await addDoc(collection(db, 'chats', chatId, 'messages'), {
    content,
    senderId,
    type: 'text',
    isRead: false,
    readBy: [senderId],
    timestamp: serverTimestamp(),
  });
}
```

### ä¸Šå‚³æª”æ¡ˆ

```typescript
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { storage } from '@/lib/firebase';

async function uploadFile(file: File, chatId: string) {
  const storageRef = ref(storage, `chats/${chatId}/${file.name}`);
  const snapshot = await uploadBytes(storageRef, file);
  const downloadURL = await getDownloadURL(snapshot.ref);
  return downloadURL;
}
```

## ä¸»è¦åŠŸèƒ½å¯¦ä½œ

### 1. å³æ™‚è¨Šæ¯ç›£è½

```typescript
import { onSnapshot, query, orderBy, collection } from 'firebase/firestore';

// ç›£è½æ–°è¨Šæ¯
const unsubscribe = onSnapshot(
  query(
    collection(db, 'chats', chatId, 'messages'),
    orderBy('timestamp', 'asc')
  ),
  (snapshot) => {
    const messages = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    setMessages(messages);
  }
);
```

### 2. ç”¨æˆ¶åœ¨ç·šç‹€æ…‹

```typescript
import { onDisconnect, ref, set } from 'firebase/database';
import { rtdb } from '@/lib/firebase';

// è¨­å®šåœ¨ç·šç‹€æ…‹
function setUserStatus(userId: string, status: 'online' | 'offline') {
  const userStatusRef = ref(rtdb, `status/${userId}`);

  set(userStatusRef, {
    status,
    lastSeen: Date.now()
  });

  // é›¢ç·šæ™‚è‡ªå‹•æ›´æ–°ç‹€æ…‹
  onDisconnect(userStatusRef).set({
    status: 'offline',
    lastSeen: Date.now()
  });
}
```

### 3. æ­£åœ¨è¼¸å…¥æŒ‡ç¤ºå™¨

```typescript
import { doc, updateDoc } from 'firebase/firestore';

// æ›´æ–°æ­£åœ¨è¼¸å…¥ç‹€æ…‹
async function setTypingStatus(chatId: string, userId: string, isTyping: boolean) {
  await updateDoc(doc(db, 'chats', chatId), {
    [`typing.${userId}`]: isTyping
  });
}
```

## éƒ¨ç½²

### Vercel éƒ¨ç½²

```bash
# å®‰è£ Vercel CLI
npm install -g vercel

# éƒ¨ç½²
vercel --prod
```

### Firebase Hosting éƒ¨ç½²

```bash
# å®‰è£ Firebase CLI
npm install -g firebase-tools

# ç™»å…¥ Firebase
firebase login

# åˆå§‹åŒ–å°ˆæ¡ˆ
firebase init hosting

# å»ºç½®å°ˆæ¡ˆ
npm run build

# éƒ¨ç½²
firebase deploy --only hosting
```

## æ•ˆèƒ½å„ªåŒ–

- âœ… åˆ†é è¼‰å…¥è¨Šæ¯ï¼ˆç„¡é™æ»¾å‹•ï¼‰
- âœ… è¨Šæ¯è™›æ“¬åŒ–ï¼ˆé•·åˆ—è¡¨å„ªåŒ–ï¼‰
- âœ… åœ–ç‰‡ lazy loading
- âœ… Firestore æŸ¥è©¢å„ªåŒ–
- âœ… é›¢ç·šæ”¯æ´ï¼ˆFirestore å¿«å–ï¼‰
- âœ… Service Workerï¼ˆPWAï¼‰

## å®‰å…¨æ€§è€ƒé‡

- ğŸ”’ Firestore å®‰å…¨è¦å‰‡
- ğŸ”’ Storage å®‰å…¨è¦å‰‡
- ğŸ”’ ç”¨æˆ¶è³‡æ–™é©—è­‰
- ğŸ”’ XSS é˜²è­·
- ğŸ”’ æª”æ¡ˆé¡å‹æª¢æŸ¥
- ğŸ”’ æª”æ¡ˆå¤§å°é™åˆ¶
- ğŸ”’ Rate Limiting

## é€²éšåŠŸèƒ½å»ºè­°

- ğŸ¥ èªéŸ³/è¦–è¨Šé€šè©±ï¼ˆWebRTCï¼‰
- ğŸ” è¨Šæ¯å…¨æ–‡æœå°‹
- ğŸ“Œ é‡˜é¸è¨Šæ¯
- ğŸ”• éœéŸ³é€šçŸ¥
- ğŸ“± æ¨æ’­é€šçŸ¥ï¼ˆFCMï¼‰
- ğŸŒ å¤šèªè¨€æ”¯æ´
- ğŸ¨ ä¸»é¡Œåˆ‡æ›
- ğŸ’¾ è¨Šæ¯å‚™ä»½
- ğŸ¤– èŠå¤©æ©Ÿå™¨äººæ•´åˆ

## å¸¸è¦‹å•é¡Œ

### Q: Firebase åˆå§‹åŒ–éŒ¯èª¤ï¼Ÿ
ç¢ºèª `.env.local` ä¸­çš„ Firebase é…ç½®æ˜¯å¦æ­£ç¢ºã€‚

### Q: è¨Šæ¯ç„¡æ³•å³æ™‚æ›´æ–°ï¼Ÿ
æª¢æŸ¥ Firestore å®‰å…¨è¦å‰‡æ˜¯å¦æ­£ç¢ºè¨­å®šã€‚

### Q: æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼Ÿ
ç¢ºèª Storage å®‰å…¨è¦å‰‡å·²è¨­å®šï¼Œä¸¦æª¢æŸ¥æª”æ¡ˆå¤§å°é™åˆ¶ã€‚

### Q: èªè­‰å¤±æ•—ï¼Ÿ
ç¢ºèª Firebase Authentication å·²å•Ÿç”¨å°æ‡‰çš„ç™»å…¥æ–¹å¼ã€‚

## æ¸¬è©¦

```bash
# å–®å…ƒæ¸¬è©¦
npm run test

# E2E æ¸¬è©¦
npm run test:e2e
```

## è²¢ç»

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

## License

MIT License

## ç›¸é—œè³‡æº

- [Firebase æ–‡æª”](https://firebase.google.com/docs)
- [Next.js æ–‡æª”](https://nextjs.org/docs)
- [React Firebase Hooks](https://github.com/CSFrequency/react-firebase-hooks)
- [Tailwind CSS æ–‡æª”](https://tailwindcss.com/docs)

## ç¯„ä¾‹å±•ç¤º

### èŠå¤©ä»‹é¢
- å·¦å´ï¼šèŠå¤©åˆ—è¡¨ï¼ˆé¡¯ç¤ºæœ€è¿‘å°è©±ã€æœªè®€è¨ˆæ•¸ï¼‰
- å³å´ï¼šèŠå¤©è¦–çª—ï¼ˆè¨Šæ¯æ°£æ³¡ã€è¼¸å…¥æ¡†ï¼‰
- å³æ™‚æ›´æ–°è¨Šæ¯
- å·²è®€/æœªè®€ç‹€æ…‹

### ç¾¤çµ„åŠŸèƒ½
- å»ºç«‹æ–°ç¾¤çµ„
- é‚€è«‹æˆå“¡åŠ å…¥
- è¨­å®šç¾¤çµ„åç¨±å’Œé ­è²¼
- ç¾¤çµ„æˆå“¡ç®¡ç†

---

**å»ºç«‹æ—¥æœŸ**: 2025-11-16
**ç‹€æ…‹**: âœ… å¯ç”¨
**ç‰ˆæœ¬**: 1.0.0
